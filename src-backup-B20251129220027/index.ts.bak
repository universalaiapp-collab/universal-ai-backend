import express, { Request, Response, NextFunction } from "express";
import dotenv from "dotenv";
import orchRoutes from "./routes/orch.routes"; // your router
import { logger } from "./lib/logger";

dotenv.config();

const PORT = process.env.PORT ? parseInt(process.env.PORT, 10) : 5000;
const app = express();

// IMPORTANT: JSON parser before routes
app.use(express.json({ limit: "5mb", strict: true }));
app.use(express.urlencoded({ extended: true, limit: "5mb" }));

// TEMP DEBUG MIDDLEWARE: logs the parsed body so we can inspect requests
app.use((req: Request, _res: Response, next: NextFunction) => {
  try {
    console.log("[DEBUG] incoming request:", req.method, req.url);
    // log body safely (avoid huge dumps)
    const shortBody = (() => {
      try {
        const b = req.body;
        if (!b) return null;
        const s = JSON.stringify(b);
        return s.length > 1000 ? s.slice(0,1000) + "...(truncated)" : s;
      } catch (e) {
        return "[unserializable body]";
      }
    })();
    console.log("[DEBUG] parsed body:", shortBody);
  } catch (e) {
    console.warn("[DEBUG] middleware error", e);
  }
  next();
});

// simple request logger
app.use((req: Request, _res: Response, next: NextFunction) => {
  logger?.info?.(`${new Date().toISOString()} ${req.method} ${req.url}`);
  next();
});

// Mount routes
app.use("/", orchRoutes);

// JSON parse error -> return JSON rather than HTML
app.use((err: any, _req: Request, res: Response, next: NextFunction) => {
  if (err && (err.type === "entity.parse.failed" || err instanceof SyntaxError)) {
    logger?.warn?.("Invalid JSON body received", err?.message ?? err);
    return res.status(400).json({ ok: false, error: "Invalid JSON body" });
  }
  next(err);
});

// Generic error handler
app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
  logger?.error?.("Unhandled error", err?.message ?? err);
  res.status(err?.status || 500).json({ ok: false, error: err?.message ?? "internal_error" });
});

// Start server
app.listen(PORT, () => {
  logger?.info?.(`Orchestrator listening on ${PORT}`);
  console.log(`Orchestrator listening on ${PORT}`);
});
