name: Wallet Doctor - daily audit

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-wallet-doctor:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runner info + repo root (debug)
        run: |
          echo "=== runner info ==="
          uname -a || true
          echo "USER: $(whoami)"
          echo "WORKDIR: $(pwd)"
          echo "LIST root (top 200 lines):"
          ls -la | sed -n '1,200p' || true
          echo "LIST level 1 files (showing some):"
          find . -maxdepth 2 -type f -printf '%p\n' | sed -n '1,200p' || true

      - name: Attempt to restore package-lock.json from origin/main then install
        run: |
          echo "Attempting to fetch a package-lock.json from origin/main (if present) and run npm ci"
          git fetch origin main --depth=1 || true

          # Try to write package-lock.json from remote origin/main if it exists
          if git show origin/main:package-lock.json > /tmp/origin-package-lock.json 2>/dev/null; then
            echo "Wrote /tmp/origin-package-lock.json from origin/main. Inspecting head:"
            head -n 8 /tmp/origin-package-lock.json || true

            # If repo already has package-lock.json file(s), choose the nearest to repo root, otherwise use the fetched one
            FOUND_LOCAL=$(find . -type f -name 'package-lock.json' -print | awk -F/ '{ print NF, $0 }' | sort -n | cut -d' ' -f2- | head -n1 || true)
            if [ -n "$FOUND_LOCAL" ]; then
              echo "Found local package-lock.json at: $FOUND_LOCAL"
              CHOSEN="$FOUND_LOCAL"
            else
              echo "No local lockfile found; using fetched origin lockfile at /tmp/origin-package-lock.json"
              mv /tmp/origin-package-lock.json ./package-lock.json
              CHOSEN=./package-lock.json
            fi

            # cd into dir containing chosen lockfile and run npm ci
            DIR=$(dirname "$CHOSEN")
            echo "Changing dir to: $DIR"
            cd "$DIR"
            echo "Running npm ci in $(pwd)"
            npm ci --prefer-offline --no-audit --no-fund
          else
            echo "No package-lock.json present on origin/main (or unable to read). Searching repo for any lockfile..."
            FOUND_ANY=$(find . -type f -name 'package-lock.json' -print | awk -F/ '{ print NF, $0 }' | sort -n | cut -d' ' -f2- | head -n1 || true)
            if [ -n "$FOUND_ANY" ]; then
              echo "Found package-lock.json at: $FOUND_ANY"
              DIR=$(dirname "$FOUND_ANY")
              cd "$DIR"
              echo "Running npm ci in $(pwd)"
              npm ci --prefer-offline --no-audit --no-fund || {
                echo "npm ci failed in $DIR; falling back to npm install"
                npm install --no-audit --no-fund
              }
            else
              echo "No lockfile found anywhere in repo workspace. Running npm install at repo root."
              npm install --no-audit --no-fund
            fi
          fi
        timeout-minutes: 15

      - name: Run wallet doctor script (if exists)
        run: |
          echo "Checking for wallet:doctor script in package.json for the current working directory..."
          if npm run | grep -q wallet:doctor; then
            echo "Found wallet:doctor script — running it now"
            npm run wallet:doctor --if-present || echo "wallet:doctor script failed or is absent"
          else
            echo "No wallet:doctor script found in this package.json — skipping"
          fi
