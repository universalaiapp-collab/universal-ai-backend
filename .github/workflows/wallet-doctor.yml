name: Wallet Doctor - daily audit

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-wallet-doctor:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show git status & commit
        run: |
          echo "=== git info ==="
          git rev-parse --abbrev-ref HEAD || true
          git log -1 --oneline || true
          echo "=== ls repo root ==="
          ls -la
          echo "=== show top-level files ==="
          find . -maxdepth 2 -type f -print || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # choose your node version
          cache: 'npm'

      - name: Debug: print node & npm
        run: |
          node --version
          npm --version
          pwd
          echo "looking for lockfiles..."
          if [ -f package-lock.json ]; then echo "FOUND package-lock.json at $(pwd)"; else echo "NO package-lock.json at $(pwd)"; fi
          if [ -f npm-shrinkwrap.json ]; then echo "FOUND npm-shrinkwrap.json"; fi
          echo "Listing repo root again:"
          ls -la

            - name: Install dependencies (robust)
        run: |
          # if your app is in a subfolder e.g. server, uncomment: cd server || true
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "Using npm ci because lockfile exists"
            npm ci --prefer-offline --no-audit --no-fund
          else
            echo "Lockfile not present â€” falling back to npm install"
            npm install --no-audit --no-fund
          fi


      - name: Run wallet doctor script (example)
        run: |
          # replace with the command your project runs
          echo "Run wallet doctor (dry-run placeholder)"
          npm run wallet:doctor --if-present || echo "wallet:doctor script not present"
