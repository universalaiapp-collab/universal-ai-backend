name: Wallet Doctor - daily audit

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  run-walletDoctor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Show repo root (debug)
        run: |
          echo "PWD=$(pwd)"
          echo "=== ls -la repo root ==="
          ls -la
          echo "=== ls -la (top 2 levels) ==="
          ls -la .
          ls -la .github || true
          echo "=== show package.json ==="
          if [ -f package.json ]; then
            jq -r '.name, .version' package.json || cat package.json | sed -n '1,20p'
          else
            echo "package.json not found"
          fi
          echo "=== package-lock.json exists? ==="
          if [ -f package-lock.json ]; then
            echo "FOUND package-lock.json — show top lines and lockfileVersion"
            sed -n '1,200p' package-lock.json || true
            grep -m1 '"lockfileVersion"' package-lock.json || true
          else
            echo "NO package-lock.json in repo root"
          fi

      - name: Install dependencies (safe)
        run: |
          if [ -f package-lock.json ]; then
            echo "Running npm ci (deterministic)"
            npm ci
          else
            echo "package-lock.json missing — running npm install"
            npm install
          fi

      - name: Run walletDoctor
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
        run: |
          node scripts/walletDoctor.js > walletDoctor-run.log 2>&1
          echo "=== walletDoctor output ==="
          sed -n '1,200p' walletDoctor-run.log || true
