name: Wallet Doctor - daily audit

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-wallet-doctor:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runner info + repo root (debug)
        run: |
          echo "=== runner info ==="
          uname -a || true
          echo "USER: $(whoami)"
          echo "WORKDIR: $(pwd)"
          echo "LIST root (top 200 lines):"
          ls -la | sed -n '1,200p' || true
          echo "LIST level 1 files (showing some):"
          find . -maxdepth 2 -type f -printf '%p\n' | sed -n '1,200p' || true

      - name: Attempt to restore package-lock.json from origin/main then install (robust)
        run: |
          echo "=== restore/install step start ==="
          set -o pipefail || true
          # Fetch latest origin/main so we can read from it
          git fetch origin main --depth=1 || true

          # Try reading package-lock.json from origin/main into a temporary file
          if git show origin/main:package-lock.json > /tmp/origin-package-lock.json 2>/dev/null; then
            echo "Successfully fetched package-lock.json from origin/main -> /tmp/origin-package-lock.json"
            echo "Head of fetched lockfile (first 8 lines):"
            head -n 8 /tmp/origin-package-lock.json || true
            FETCHED=1
          else
            echo "No package-lock.json found on origin/main (or unable to read it)"
            FETCHED=0
          fi

          # Find any local package-lock.json files (prefer the one closest to repo root)
          local_lock=$(find . -type f -name 'package-lock.json' -print | awk -F/ '{ print NF, $0 }' | sort -n | cut -d' ' -f2- | head -n1 || true)
          if [ -n "$local_lock" ]; then
            echo "Found local package-lock.json at: $local_lock"
            CHOSEN="$local_lock"
          elif [ "$FETCHED" -eq 1 ]; then
            echo "No local lockfile found; using fetched origin lockfile."
            mv /tmp/origin-package-lock.json ./package-lock.json
            CHOSEN="./package-lock.json"
          else
            echo "No lockfile anywhere (local or origin). Will run npm install at repo root."
            CHOSEN=""
          fi

          # If we have a chosen lockfile, cd to its directory and run npm ci
          if [ -n "$CHOSEN" ]; then
            dir=$(dirname "$CHOSEN")
            echo "Switching to directory: $dir"
            cd "$dir"
            echo "PWD: $(pwd)"
            echo "Listing files in $(pwd):"
            ls -la | sed -n '1,200p' || true
            echo "Running npm ci (deterministic install) in $(pwd)"
            npm ci --prefer-offline --no-audit --no-fund
            exit_code=$?
            if [ $exit_code -ne 0 ]; then
              echo "npm ci failed with exit code $exit_code. Attempting npm install as fallback."
              npm install --no-audit --no-fund
            fi
          else
            echo "No lockfile chosen; running npm install in repo root $(pwd)"
            npm install --no-audit --no-fund
          fi
          echo "=== restore/install step end ==="
        timeout-minutes: 20

      - name: Run wallet doctor script (if exists)
        run: |
          echo "=== wallet doctor step start ==="
          # If package.json scripts exist in current directory, try to run wallet:doctor
          if [ -f package.json ]; then
            echo "package.json found in $(pwd)"
            if npm run | grep -q wallet:doctor; then
              echo "Found wallet:doctor script — running it now"
              npm run wallet:doctor --if-present || echo "wallet:doctor script failed or returned non-zero"
            else
              echo "No wallet:doctor script in this package.json — skipping"
            fi
          else
            echo "No package.json in current directory; skipping wallet:doctor"
          fi
          echo "=== wallet doctor step end ==="
